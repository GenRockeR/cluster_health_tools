<form>
  <label>Forwarder performance</label>
  <init>
    <set token="_internal">(index=_internal OR index=core_splunk_internal)</set>
    <set token="selected_ingest_pipe">*</set>
  </init>
  <search id="thruput_thruput">
    <query>$_internal$ host=$selected_forwarder$ METRICS TERM(group=thruput) TERM(name=thruput) 
| fillnull ingest_pipe 0 
| bin _time span=31sec
| stats
    $selected_thruput_function$(instantaneous_kbps) as instantaneous_kbps
    $selected_thruput_function$(instantaneous_eps) as instantaneous_eps
    $selected_thruput_function$(average_kbps) as average_kbps
    $selected_thruput_function$(total_k_processed) as total_k_processed
    $selected_thruput_function$(kb) as kb
    $selected_thruput_function$(ev) as ev
    $selected_thruput_function$(load_average) as load_average
    by _time ingest_pipe
    
</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="connecting_forwarders">
    <query>$_internal$ Metrics sourcetype=splunkd TERM(group=tcpin_connections) host=$selected_forwarder$ 
| fillnull ingest_pipe 0
| stats 
    sum(kb) as sum_kb
    avg(chan_new_kBps) as avg_chan_new_kBps
    max(tcp_KBps) as max_tcp_KBps
    stdev(tcp_KBps) as stdev_tcp_KBps
    values(connectionType) as connectionType
    values(arch) as arch
    values(version) as version
    values(fwdType) as type
    values(ssl) as ssl
    values(os) as os
    values(guid) as guid
    dc(guid) as guid_count
    dc(sourceIp) as count_sources
    by hostname ingest_pipe
| eventstats 
    sum(max_tcp_KBps) as total_sum_avg_KBps
    stdev(tcp_KBps) as avg_stdev_KBps
    sum(sum_kb) as total_sum_kb 
    dc(guid) as all_forwarders 
    max(indexer_count) as all_indexers
    by ingest_pipe
| eval indexer_coverage=indexer_count."/".all_indexers,
indexer_coverage_pct=indexer_count/all_indexers
| sort 0 - sum_kb 
| streamstats 
    sum(sum_kb) as accumlated_sum_kb 
    count as ranking_most_data_kb
    by all_forwarders ingest_pipe
| eval coverage_kb=accumlated_sum_kb/total_sum_kb, 
    progress_through_forwarders_kb=(ranking_most_data_kb/all_forwarders) * 100 
| sort 0 - max_tcp_KBps 
| streamstats 
    sum(max_tcp_KBps) as accumlated_avg_kbps 
    count as ranking_most_data_kbps
    by all_forwarders ingest_pipe
| eval coverage_kbps=accumlated_avg_kbps/total_sum_avg_KBps, 
    progress_through_forwarders_kbps=(ranking_most_data_kbps/all_forwarders) * 100 
| rename ranking_most_data_kbps as "speed ranking" 
| rename ranking_most_data_kb as "volume ranking" 
| rename max_tcp_KBps as "max speed" 
| eval "%"='%'*100,
    "speed variability" = (stdev_tcp_KBps/'max speed')*100,
    "data"=sum_kb/1024/1024,
    "data %"= (sum_kb/total_sum_kb) * 100</query>
    <earliest>$selection_earliest$</earliest>
    <latest>$selection_latest$</latest>
  </search>
  <search id="per_series_thruput">
    <query>$_internal$ host=$selected_forwarder$ METRICS sourcetype=splunkd TERM(kb=*) TERM(kbps=*) TERM(ev=*) TERM(eps=*) TERM(group=*) TERM(series=*)
| fillnull ingest_pipe 0
| table _time host group ingest_pipe series eps ev kbps kb max_age avg_age</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="pipeline_processor">
    <query>$_internal$ host=$selected_forwarder$ METRICS METRICS TERM(group=pipeline) TERM(processor=*)
| fillnull ingest_pipe 0
| table _time host ingest_pipe processor name executes cpu_seconds cumulative_hits
| bin _time span=31sec 
</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search base="pipeline_processor" id="pipeline_processor_aggregated">
    <query>| stats avg(cpu_seconds) as cpu_seconds
    avg(executes) as executes
    avg(cumulative_hits) as cumulative_hits
    by _time processor ingest_pipe name</query>
  </search>
  <search id="annotation_blocking">
    <query>$_internal$ host=$selected_forwarder$ source=*metrics* TERM(blocked=true) 
| stats values(name) as name by host _time ingest_pipe 
| eval 
    annotation_label= "pipeline #".ingest_pipe." blocked", 
    annotation_category=mvjoin(name,"+") 
| table _time anno* ingest_pipe</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="annotation_blocking_filtered" base="annotation_blocking">
    <query>
      | search ingest_pipe=$selected_ingest_pipe$
    </query>
  </search>
  <search id="channels">
    <query>
$_internal$ host=$selected_forwarder$ TERM(group=map) TERM(name=pipelineinputchannel)
| fillnull ingest_pipe 0 
| table _time host ingest_pipe current_size inactive_channels new_channels removed_channels reclaimed_channel timedout_channels abandoned_channels 
</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="queue">
    <query>$_internal$ Metrics sourcetype=splunkd host=$selected_forwarder$ TERM(group=queue) NOT(largest_size=0) TERM(max_size_kb=*) NOT(current_size_kb=0)
| fillnull ingest_pipe 0 
| bin _time span=62sec 
| stats 
    avg(current_size_kb) as current_size_kb
    by _time ingest_pipe host name max_size_kb
| eval normalized_pct=(current_size_kb/max_size_kb) * 100
</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="tcp_out">
    <query>$_internal$ Metrics sourcetype=splunkd TERM(group=tcpout_connections) host=$selected_forwarder$ 
| fillnull ingest_pipe 0 
| bin _time span=31sec 
| stats
    sum(tcp_Kprocessed) as tcp_Kprocessed
    median(tcp_avg_thruput) as tcp_avg_thruput
    avg(tcp_eps) as tcp_eps
    by _time ingest_pipe name sourcePort destIp destPort
| table _time ingest_pipe name sourcePort destIp destPort tcp_Kprocessed tcp_avg_thruput tcp_eps
</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>Select forwarder</label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="text" token="selected_forwarder">
      <label>Enter forwarder name</label>
    </input>
  </fieldset>
  <row rejects="$selected_forwarder$">
    <panel>
      <html>
        <h1 style="text-align:center">Please enter an exact hostname</h1>
      </html>
    </panel>
  </row>
  <row depends="$selected_forwarder$">
    <panel>
      <title>The net throughput per pipeline for $selected_forwarder$ for all pipelines - select a pipeline for more detail</title>
      <input type="dropdown" token="selected_thruput_variable">
        <label>Select field to show</label>
        <choice value="instantaneous_kbps">instantaneous_kbps</choice>
        <choice value="instantaneous_eps">instantaneous_eps</choice>
        <choice value="average_kbps">average_kbps</choice>
        <choice value="total_k_processed">total_k_processed</choice>
        <choice value="kb">kb</choice>
        <choice value="ev">ev</choice>
        <choice value="load_average">load_average</choice>
        <default>instantaneous_kbps</default>
      </input>
      <input type="dropdown" token="selected_thruput_function">
        <label>Selection aggregation function</label>
        <choice value="avg">average</choice>
        <choice value="median">median</choice>
        <choice value="mean">mean</choice>
        <choice value="stdev">standard dev</choice>
        <choice value="per_second">per_second</choice>
        <choice value="p90">p90</choice>
        <choice value="p95">p95</choice>
        <choice value="p99">p99</choice>
        <choice value="max">max</choice>
        <choice value="min">min</choice>
        <choice value="sum">sum</choice>
        <choice value="range">range</choice>
        <choice value="var">variance</choice>
        <default>avg</default>
      </input>
      <chart>
        <search base="thruput_thruput">
          <query>| xyseries _time ingest_pipe $selected_thruput_variable$
| eval *=0
| foreach * [| eval *='*'+'&lt;&lt;FIELD&gt;&gt;']
          
          </query>
        </search>
        <search base="annotation_blocking" type="annotation"></search>
        <option name="charting.axisY2.enabled">1</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.overlayFields">*</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">461</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="selected_ingest_pipe">$click.name2$</set>
        </drilldown>
        <selection>
          <set token="selection_earliest">$start$</set>
          <set token="selection_latest">$end$</set>
        </selection>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Queue filling for $selected_ingest_pipe$ on $selected_forwarder$</title>
      <input type="dropdown" token="queue_fill">
        <label>Queue fill measure</label>
        <choice value="normalized_pct">Normalized %</choice>
        <choice value="current_size_kb">Absolute</choice>
        <default>current_size_kb</default>
      </input>
      <chart>
        <search base="queue">
          <query>| search ingest_pipe=$selected_ingest_pipe$ _time&gt;=$selection_earliest$ _time&lt;=$selection_latest$
| timechart fixedrange=false span=31sec avg($queue_fill$) by name</query>
        </search>
        <search base="annotation_blocking_filtered" type="annotation">
          <query/>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">353</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$selected_forwarder$">
    <panel>
      <title>Throughput for $selected_group$ on $selected_ingest_pipe$ on $selected_forwarder$</title>
      <input type="dropdown" token="selected_group">
        <label>Select series</label>
        <choice value="per_index_thruput">per_index_thruput</choice>
        <choice value="per_host_thruput">per_host_thruput</choice>
        <choice value="per_source_thruput">per_source_thruput</choice>
        <choice value="per_sourcetype_thruput">per_sourcetype_thruput</choice>
        <default>per_sourcetype_thruput</default>
      </input>
      <chart>
        <search base="per_series_thruput">
          <query>| search group=$selected_group$ ingest_pipe=$selected_ingest_pipe$ _time&gt;=$selection_earliest$ _time&lt;=$selection_latest$
| bin _time span=31sec 
| stats avg(eps) as eps
    avg(kb) as kb
    avg(ev) as ev
    avg(kbps) as kbps
    avg(max_age) as max_age
    avg(avg_avg_age) as avg_age
    by _time series host
| timechart fixedrange=false span=31 limit=30 avg(kb) as kb by series</query>
        </search>
        <search base="annotation_blocking_filtered" type="annotation">
          <query>| search ingest_pipe=$selected_ingest_pipe$</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">419</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$selected_forwarder$">
    <panel>
      <title>Pipeline processor cpu and execution for pipeline $selected_ingest_pipe$ on $selected_forwarder$</title>
      <input type="dropdown" token="selected_processor_function">
        <label>Selection aggregation function</label>
        <choice value="avg">average</choice>
        <choice value="median">median</choice>
        <choice value="mean">mean</choice>
        <choice value="stdev">standard dev</choice>
        <choice value="per_second">per_second</choice>
        <choice value="p90">p90</choice>
        <choice value="p95">p95</choice>
        <choice value="p99">p99</choice>
        <choice value="max">max</choice>
        <choice value="min">min</choice>
        <choice value="sum">sum</choice>
        <choice value="range">range</choice>
        <choice value="var">variance</choice>
        <default>avg</default>
      </input>
      <input type="dropdown" token="selected_processor">
        <label>Select process and name</label>
        <choice value="processor=* name=*">processor=* name=*</choice>
        <default>processor=* name=*</default>
        <fieldForLabel>search</fieldForLabel>
        <fieldForValue>search</fieldForValue>
        <search base="pipeline_processor_aggregated">
          <query>| stats count by processor name 
| eval search="processor=".processor." name=".name 
| appendpipe 
    [| stats count by name 
    | eval search="name=".name." processor=*"]

| appendpipe 
    [| stats count by processor 
    | eval search="name=* processor=".processor]</query>
        </search>
      </input>
      <input type="dropdown" token="selected_processor_variable">
        <label>Select variable to plot</label>
        <choice value="cpu_seconds">cpu_seconds</choice>
        <choice value="executes">executes</choice>
        <choice value="cumulative_hits">cumulative_hits</choice>
        <default>cpu_seconds</default>
      </input>
      <chart>
        <search base="annotation_blocking_filtered" type="annotation"></search>
        <search base="pipeline_processor_aggregated">
          <query>| search ingest_pipe=$selected_ingest_pipe$ $selected_processor$ _time&gt;=$selection_earliest$ _time&lt;=$selection_latest$
| eval key="#".ingest_pipe." ".processor." &amp; ".name 
| timechart fixedrange=false limit=50 span=31sec avg($selected_processor_variable$) by key</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">484</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Channel creation for pipeline $selected_ingest_pipe$ on $selected_forwarder$</title>
      <input type="dropdown" token="channel_variable">
        <label>Selection aggregation function</label>
        <choice value="current_size">current_size</choice>
        <choice value="inactive_channels">inactive_channels</choice>
        <choice value="new_channels">new_channels</choice>
        <choice value="removed_channels">removed_channels</choice>
        <choice value="reclaimed_channel">reclaimed_channel</choice>
        <choice value="timedout_channels">timedout_channels</choice>
        <choice value="abandoned_channels">abandoned_channels</choice>
        <choice value="*">*</choice>
        <default>*</default>
      </input>
      <chart>
        <search base="channels">
          <query>| search ingest_pipe=$selected_ingest_pipe$ _time&gt;=$selection_earliest$ _time&lt;=$selection_latest$
| timechart fixedrange=false span=31sec limit=30
    avg(current_size) as current_size
    avg(inactive_channels) as inactive_channels
    avg(new_channels) as new_channels
    avg(removed_channels) as removed_channels
    avg(reclaimed_channel) as reclaimed_channel
    avg(timedout_channels) as timedout_channels
    avg(abandoned_channels) as abandoned_channels
    by ingest_pipe
| fields $channel_variable$*     
    </query>
        </search>
        <search base="annotation_blocking_filtered" type="annotation"></search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">467</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>TCP output metrics for pipeline $selected_ingest_pipe$ on $selected_forwarder$</title>
      <input type="dropdown" token="tcp_out_variable">
        <label>Select variable</label>
        <choice value="tcp_Kprocessed">tcp_Kprocessed</choice>
        <choice value="tcp_avg_thruput">tcp_avg_thruput</choice>
        <choice value="tcp_eps">tcp_eps</choice>
        <default>tcp_avg_thruput</default>
      </input>
      <input type="dropdown" token="tcp_out_splitby">
        <label>Select variable</label>
        <choice value="destIp">destIp</choice>
        <choice value="name">name</choice>
        <choice value="sourcePort">sourcePort</choice>
        <default>destIp</default>
      </input>
      <chart>
        <search base="tcp_out">
          <query>| search ingest_pipe=$selected_ingest_pipe$ _time&gt;=$selection_earliest$ _time&lt;=$selection_latest$
| timechart limit=80 fixedrange=false avg($tcp_out_variable$) by $tcp_out_splitby$</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">412</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$selected_forwarder$">
    <panel>
      <title>Forwarders connecting to $selected_forwarder$ showing $selected_forwarder_count$ forwarders</title>
      <input type="dropdown" token="selected_forwarder_version">
        <label>Filter forwarder version</label>
        <choice value="*">*</choice>
        <search base="connecting_forwarders">
          <query>| stats count by version
| eval label=version." (".count." instances)"</query>
        </search>
        <fieldForLabel>label</fieldForLabel>
        <fieldForValue>version</fieldForValue>
        <default>*</default>
      </input>
      <input type="dropdown" token="selected_forwarder_type">
        <label>Filter forwarder type</label>
        <choice value="*">*</choice>
        <search base="connecting_forwarders">
          <query>| stats count by type
| eval label=type." (".count." instances)"
| sort - count</query>
        </search>
        <fieldForLabel>label</fieldForLabel>
        <fieldForValue>type</fieldForValue>
        <default>*</default>
      </input>
      <input type="dropdown" token="selected_forwarder_os">
        <label>Filter forwarder OS</label>
        <choice value="*">*</choice>
        <search base="connecting_forwarders">
          <query>| stats count by os
| eval label=os." (".count." instances)"
| sort - count</query>
        </search>
        <fieldForLabel>label</fieldForLabel>
        <fieldForValue>os</fieldForValue>
        <default>*</default>
      </input>
      <table>
        <title>For more detail click on some forwarders and more charts will open allowing you to compare performance and behaviours of those you selected</title>
        <search base="connecting_forwarders">
          <progress>
            <set token="selected_forwarder_count">$job.resultCount$</set>
          </progress>
          <done>
            <set token="selected_forwarder_count">$job.resultCount$</set>
          </done>
          <query>| search type=$selected_forwarder_type$ os=$selected_forwarder_os$ version=$selected_forwarder_version$ ingest_pipe=$selected_ingest_pipe$
| rename guid_count as "# guids"
| table hostname guid guid_count ingest_pipe "volume ranking" "speed ranking" "indexer coverage"  "%" "max speed" "speed variability" "data" "data %" "os" "type" "version" arch
| sort 0 "volume ranking"
| rename ingest_pipe as "ingest pipe"</query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">cell</option>
        <format type="number" field="indexer coverage">
          <option name="precision">0</option>
          <option name="unit">%</option>
        </format>
        <format type="number" field="max speed">
          <option name="precision">0</option>
          <option name="unit">KBps</option>
        </format>
        <format type="number" field="speed variability">
          <option name="precision">0</option>
          <option name="unit">%</option>
        </format>
        <format type="color" field="%">
          <colorPalette type="list">[#D93F3C,#FFFFFF]</colorPalette>
          <scale type="threshold">99</scale>
        </format>
        <format type="color" field="max speed">
          <colorPalette type="minMidMax" maxColor="#31A35F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="speed variability">
          <colorPalette type="minMidMax" maxColor="#1E93C6" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="number" field="data">
          <option name="unit">GB</option>
        </format>
        <format type="color" field="data">
          <colorPalette type="minMidMax" maxColor="#31A35F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="number" field="data %">
          <option name="precision">0</option>
          <option name="unit">%</option>
        </format>
        <format type="color" field="data %">
          <colorPalette type="minMidMax" maxColor="#31A35F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="number" field="%">
          <option name="precision">0</option>
        </format>
        <drilldown>
          <link target="_blank">/app/search/forwarder_performance?form.selected_forwarder=$row.hostname$&amp;form.time.earliest=$selection_earliest$&amp;form.time.latest=$selection_latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</form>
