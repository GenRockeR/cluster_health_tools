<form>
  <label>Cluster Performance 2</label>
  <description>Another groovy operations dashboard brought to you by Richard Morgan Productions</description>
  <init>
    <set token="time.latest">-0d@d</set>
  </init>
  <search id="hostwide_report">
    <query>
| tstats 
    avg(data.cpu_idle_pct) as cpu_idle_pct
    avg(data.mem_used) as mem_used
    avg(data.normalized_load_avg_1min) as normalized_load_avg_1min 
    where component=hostwide
    index=customer_introspection
    host=*.$selected_stack$.splunkcloud.com
    by data.os_build data.os_version data.splunk_version data.cpu_count data.mem data.instance_guid host _time span=$seconds_for_bin_62$sec 
$run_hostwide_report$
| eval cpu_used_pct=100-cpu_idle_pct    
| rex field=host "(?&lt;host_short&gt;.*[^\.]+)\."
</query>
    <earliest>$tweaked_earliest$</earliest>
    <latest>$tweaked_latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label></label>
      <default>
        <earliest>-1d@d</earliest>
        <latest>now</latest>
      </default>
      <change>
        <eval token="sample_ratio">round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/86400)+1</eval>
        <eval token="seconds_for_bin_31">if((round(relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$)&lt;31,31,round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$))</eval>
        <eval token="seconds_for_bin_62">if((round(relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$)&lt;62,62,round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$))</eval>
        <eval token="tweaked_earliest">relative_time(now(), $time.earliest$)</eval>
        <eval token="tweaked_latest">relative_time(now(), $time.latest$)</eval>
        <eval token="time.latest">if($time.latest$="now","-0d@d",$time.latest$)</eval>
      </change>
    </input>
    <input type="dropdown" token="account_name">
      <label>Filter by build type</label>
      <choice value="*">all</choice>
      <default>*</default>
      <prefix>aws_account_name="</prefix>
      <suffix>"</suffix>
      <fieldForLabel>label</fieldForLabel>
      <fieldForValue>aws_account_name</fieldForValue>
      <search>
        <query>| inputlookup aws_inventory 
| stats dc(stack) by aws_account_name 
| eval label=aws_account_name." (".count." instances)"</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="dropdown" token="selected_stack">
      <label>Select stack</label>
      <fieldForLabel>label</fieldForLabel>
      <fieldForValue>stack_derived</fieldForValue>
      <search>
        <query>
| inputlookup aws_inventory where role="indexer" $account_name$
| stats count by stack instance_type aws_account_id 
| rename stack AS stack_derived 
| sort - count 
| eval label=count." x ".mvjoin(instance_type,", ") 
| stats sum(count) as count values(label) as label by stack_derived aws_account_id 
| eval label=stack_derived." (".mvjoin(label,", ").") - " 
| stats sum(count) as count values(label) as label by stack_derived
| sort - count
| eval label=mvjoin(label,", ")
</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <change>
        <eval token="sample_ratio">round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/86400)+1</eval>
        <eval token="seconds_for_bin_31">if((round(relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$)&lt;31,31,round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$))</eval>
        <eval token="seconds_for_bin_31">if((round(relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$)&lt;62,62,round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$))</eval>
        <eval token="tweaked_earliest">relative_time(now(), $time.earliest$)</eval>
        <eval token="tweaked_latest">relative_time(now(), $time.latest$)</eval>
      </change>
    </input>
    <input type="dropdown" token="time_resolution">
      <label>Chart resolution</label>
      <choice value="100">Crude</choice>
      <choice value="250">Low</choice>
      <choice value="500">Medium</choice>
      <choice value="750">High</choice>
      <choice value="999">Ultra</choice>
      <default>500</default>
      <change>
        <eval token="seconds_for_bin_31">if((round(relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$)&lt;31,31,round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$))</eval>
        <eval token="seconds_for_bin_62">if((round(relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$)&lt;62,62,round((relative_time(now(), $time.latest$)-relative_time(now(), $time.earliest$))/$time_resolution$))</eval>
      </change>
    </input>
    <input type="checkbox" token="show_report_selector">
      <label></label>
      <choice value="| noop">Select reports</choice>
      <delimiter/>
    </input>
  </fieldset>
  <row depends="$show_report_selector$">
    <panel>
      <title>Show elements</title>
      <input type="checkbox" token="run_hostwide_report">
        <label></label>
        <choice value="| noop">Indexers</choice>
        <delimiter/>
      </input>
    </panel>
  </row>  <row depends="$selected_stack$">
    <panel>
      <title>Click to reload this dashboard with absolute time so that you can share the URL with others (sample ratio $sample_ratio$)</title>
      <single>
        <search>
          <query>| makeresults 
| addinfo 
| eval label="$selected_stack$ @ ".strftime("$tweaked_earliest$","%D %T")."-&gt;".strftime("$tweaked_latest$","%D %T")
| fields + label</query>
          <earliest>$tweaked_earliest$</earliest>
          <latest>$tweaked_latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_self">/app/stk-app-SEArchitects/cluster_performance_2?form.time.earliest=$tweaked_earliest$&amp;form.time.latest=$tweaked_latest$&amp;form.selected_stack=$selected_stack$&amp;form.selected_host=$selected_host$&amp;form.resolution=$time_resolution$</link>
        </drilldown>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Indexer load</title>
        <search base="cpu_load_base">
          <query>| search host=idx* 
| timechart span=$seconds_for_bin_62$sec limit=0 
    avg(normalized_load_avg_1min) as avg_load
    stdev(normalized_load_avg_1min) as stdev_load
    max(normalized_load_avg_1min) as max_load 
    min(normalized_load_avg_1min) as min_load</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">303</option>
        <option name="refresh.display">progressbar</option>
        <selection>
          <set token="selection_earliest_load">$start$</set>
          <set token="selection_latest_load">$end$</set>
        </selection>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <div>
        <a target="_blank" href="/app/stk-app-SEArchitects/cluster_performance_2?form.time.earliest=$selection_earliest_load$&amp;form.time.latest=$selection_latest_load$&amp;form.selected_stack=$selected_stack$&amp;form.selected_host=$selected_host$&amp;form.resolution=$time_resolution$">reload for narrowed time range</a>
        </div>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Indexer cpu</title>
        <search base="cpu_load_base">
          <query>| search host=idx* 
| timechart span=$seconds_for_bin_62$sec limit=0 
    avg(cpu_used_pct) as avg_cpu
    stdev(cpu_used_pct) as stdev_cpu
    max(cpu_used_pct) as max_cpu
    min(cpu_used_pct) as min_cpu</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">299</option>
        <option name="refresh.display">progressbar</option>
        <selection>
          <set token="selection_earliest_cpu">$start$</set>
          <set token="selection_latest_cpu">$end$</set>
        </selection>
        <drilldown>
          <set token="show_indexer_cpu">| noop</set>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row depends="$show_indexer_cpu$">
    <panel>
      <input type="checkbox" token="dummy">
        <label></label>
        <choice value="| noop">Toggle to hide panel</choice>
        <change>
          <unset token="show_indexer_cpu"></unset>
        </change>
      </input>
      <table>
        <search base="cpu_load_base">
          <query>$show_indexer_cpu$
| search host=idx* 
| stats 
    max(normalized_load_avg_1min) as max_load
    avg(normalized_load_avg_1min) as avg_avg_load
    sparkline(avg(normalized_load_avg_1min),$seconds_for_bin_62$sec) as avg_load
    max(cpu_used_pct) as max_cpu_pct
    avg(cpu_used_pct) as avg_avg_cpu_pct
    sparkline(avg(cpu_used_pct),$seconds_for_bin_62$sec) as avg_cpu_pct

    by host_short data.splunk_version data.os_version data.cpu_count mem_used data.mem
| eval mem_used_pct=('mem_used'/'data.mem')*100
| fields - mem_used data.mem</query>
        </search>
        <option name="count">100</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Search head load</title>
      <chart>
        <search base="cpu_load_base">
          <query>| search host=sh*
| timechart span=$seconds_for_bin_62$sec limit=0 p99(normalized_load_avg_1min) by host_short</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">top</option>
        <option name="height">369</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Search head CPU</title>
      <chart>
        <search base="cpu_load_base">
          <query>| search host=sh*
| timechart span=$seconds_for_bin_62$sec limit=0 p99(cpu_used_pct) by host_short</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">top</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <search base="cpu_load_base">
          <query>| search host=sh*
| stats 
    max(normalized_load_avg_1min) as max_load
    avg(normalized_load_avg_1min) as avg_avg_load
    sparkline(avg(normalized_load_avg_1min),$seconds_for_bin_62$sec) as avg_load
    max(cpu_used_pct) as max_cpu_pct
    avg(cpu_used_pct) as avg_avg_cpu_pct
    sparkline(avg(cpu_used_pct),$seconds_for_bin_62$sec) as avg_cpu_pct
    by host_short</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <search base="cpu_load_base">
          <query>| search host=c0m*
| timechart span=$seconds_for_bin_62$sec limit=0 p99(normalized_load_avg_1min) by host_short</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <search base="cpu_load_base">
          <query>| search host=c0m*
| timechart span=$seconds_for_bin_62$sec limit=0 p99(normalized_load_avg_1min) by host_short</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <search base="cpu_load_base">
          <query>| search host=c0m*
| timechart span=$seconds_for_bin_62$sec limit=0 p99(normalized_load_avg_1min) by host_short</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
</form>
